<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/x-icon" href="./favicon.ico">
  <title>Simple TOTP</title>
  <style>
    :root {
      --bg-color: #eee;
      --text-color: #222;
    }

    [data-theme="dark"] {
      --bg-color: #1e1e1e;
      --text-color: #ccc;
    }
    main {
        display: grid;
        grid-template-columns: 1fr;
        row-gap: 1em;
    }
    section, header {
        display: flex;
        justify-content: center;
    }
    section {
        gap: 1em;
    }
    label {
      display: block;
    }
    div#code {
        font-weight: bold;
        font-size: x-large;
    }
  </style>
  <script>

    function loadNamespaces() {
        if (!checkPassword())
            return
        ajax.get({url:`./bin/simtotp?pass=${encodeURIComponent(document.querySelector('input[name="password"]').value)}&op=lsns&`, success: function(json) {
              const messageElement = document.querySelector('#message')
              if (!json.length) {
                  messageElement.textContent = json.error
                  return
              }
              const selectElement = document.querySelector('#namespaceName')
              selectElement.innerHTML = ''
              json.forEach(data => {
                  if (data) {
                    const newOption = new Option(data, data);
                    selectElement.appendChild(newOption);
                  }
              })
              messageElement.textContent = ''
              document.querySelector('#namespace').addEventListener('input', (event) => {
                    const selectedValue = event.target.value;
                    ajax.get({url:`./bin/simtotp?pass=${encodeURIComponent(document.querySelector('input[name="password"]').value)}&op=lsac&name=${encodeURIComponent(selectedValue)}`, success: function(json) {
                         const messageElement = document.querySelector('#message')
                        if (!json.length) {
                              messageElement.textContent = json.error
                              return
                          }
                          const selectElement = document.querySelector('#accountName')
                          selectElement.innerHTML = ''
                          document.querySelector('#account').value = ''
                          json.forEach(data => {
                              if (data) {
                                const newOption = new Option(data, data);
                                selectElement.appendChild(newOption);
                              }
                          })
                          messageElement.textContent = ''
                    }})
                });
          } })
    }
    function gen() {
        if (!checkPassword())
            return
        if (!document.querySelector('#namespace').value || !document.querySelector('#account').value) {
            const messageElement = document.querySelector('#message')
            messageElement.textContent = 'a name space and an account are required to get a code'
            return
        }
        ajax.get({url:`./bin/simtotp?pass=${encodeURIComponent(document.querySelector('input[name="password"]').value)}&op=gen&name=${encodeURIComponent(document.querySelector('#namespace').value)}&account=${encodeURIComponent(document.querySelector('#account').value)}`, success: function(json) {
              const messageElement = document.querySelector('#message')
              if (json.error) {
                  messageElement.textContent = json.error
                  return
              } else {
                  messageElement.textContent = ''
              }
              const codeElement = document.querySelector('#code')
              codeElement.textContent = json.code
              const cbdBtn = document.querySelector('#cbd')
              cbdBtn.removeAttribute("hidden")
              setTimeout(() => {
                  cbdBtn.setAttribute("hidden",'');
                  codeElement.textContent = ''
                  messageElement.textContent = 'the code was expired'
                }, 30000)
              
        }})
    }
    function update() {
        if (!checkPassword())
            return
        ajax.get({url:`./bin/simtotp?pass=${encodeURIComponent(document.querySelector('input[name="password"]').value)}&op=adac&name=${encodeURIComponent(document.querySelector('#namespace').value)}&account=${encodeURIComponent(document.querySelector('#account').value)}&secret=${document.querySelector('#secret').value}`, success: function(json) {
              if (json.error) {
                  const messageElement = document.querySelector('#message')
                  messageElement.textContent = json.error
                  return
              }
              document.querySelector('#secret').value = ''
              loadNamespaces()
        }})
    }
    function del() {
        if (!checkPassword())
            return
        const namespaceName = document.querySelector('#namespace').value
        if (namespaceName) {
            const accountName = document.querySelector('#account').value
            if (accountName) {
                ajax.get({url:`./bin/simtotp?pass=${encodeURIComponent(document.querySelector('input[name="password"]').value)}&op=deac&name=${encodeURIComponent(namespaceName)}&account=${encodeURIComponent(accountName)}`, success: function(json) {
                    const messageElement = document.querySelector('#message')
                    if (json.error) {
                          messageElement.textContent = json.error
                          return
                    }
                    document.querySelector('#account').value = ''
                }})
            } else {
                ajax.get({url:`./bin/simtotp?pass=${encodeURIComponent(document.querySelector('input[name="password"]').value)}&op=dens&name=${encodeURIComponent(namespaceName)}`, success: function(json) {
                    const messageElement = document.querySelector('#message')
                    if (json.error) {
                          messageElement.textContent = json.error
                          return
                    }
                }})
            }
            document.querySelector('#namespace').value = ''
            messageElement.textContent = ''
        }
        loadNamespaces()
    }
    function download() {
        if (!checkPassword())
            return
        const password = prompt("Provide password for data (optional)?")
        const link = document.createElement("a");
        link.href = `./bin/simtotp?op=dndb&pass=${encodeURIComponent(document.querySelector('input[name="password"]').value)}&dnpassword=${encodeURIComponent(password)}`;
        link.download = 'totp.db';
        link.click();
    }
    function upload() {
        if (!checkPassword())
            return
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.multiple = false; 
        fileInput.addEventListener('change', (event) => {
            const files = event.target.files;
            const password = prompt("Provide password for data (optional)?")
            const uri = `./bin/simtotp?op=updb&pass=${encodeURIComponent(document.querySelector('input[name="password"]').value)}&dnpassword=${encodeURIComponent(password)}`;
            const xhr = new XMLHttpRequest();
            const fd = new FormData();
    
            xhr.open("POST", uri, true);
            xhr.onreadystatechange = () => {
              if (xhr.readyState === 4 && xhr.status === 200) {
                  
                  const resp = JSON.parse(xhr.responseText)
                  if (resp.error) {
                      const messageElement = document.querySelector('#message')
                      messageElement.textContent = resp.error
                  } else {
                      loadNamespaces()
                  }
              }
            };
            fd.append("upFile", files[0]);
            xhr.send(fd);
        });
        fileInput.click()
    }
    function checkPassword() {
        if (!document.querySelector('input[name="password"]').value) {
            const messageElement = document.querySelector('#message')
            messageElement.textContent = 'enter a password first'
            return false
        }
        return true
    }
    function copyClbd() {
        const codeDiv = document.querySelector('#code')
        const textToCopy = codeDiv.innerText;
        if (textToCopy) {
              const messageElement = document.querySelector('#message')
              const textarea = document.createElement('textarea')
              textarea.id = 'temp_element'
              textarea.style.height = 0
              document.body.appendChild(textarea)
              textarea.value = textToCopy
              const selector = document.querySelector('#temp_element')
              selector.select()
              document.execCommand('copy')
              document.body.removeChild(textarea)
              messageElement.textContent = 'Text copied to clipboard successfully';
        }
    }
    function version(footer) {
        ajax.get({url:`./bin/simtotp?pass=&op=vers`, success: function(json) {
            if (json.ok) {
                  footer.textContent = `${json.version} Â© ${new Date().getFullYear()} D Rogatkin`
            }
        }})
    }
  </script>
  <script src="./common.js" language="Javascript"></script>
</head>

<body>
    <header><h1>Rust TOTP</h1></header>
    <main>
        <section>
        <div id="passwordSec">
            <label for="password">Password</label>
            <input type="password" name="password" required  autofocus/>
        </div>
        <div id="namespaces">
            <label for="namespace">Namespace</label>
            <input type="text" id="namespace" list="namespaceName" />
            <datalist id="namespaceName" size="3" required></datalist>
        </div>
        <div id="accounts">
            <label for="account">Account</label>
            <input type="text" id="account" list="accountName" />
            <datalist id="accountName" size="6" required></datalist>
        </div>
        <div id="secretsecret">
            <label for="secret">Secret</label>
            <input type="password" id="secret" />
        </div>
        </section>
        <section>
            <button type="button" onclick="loadNamespaces()">Update</button>
            <button type="button" onclick="gen()" style="font-weight: bold;padding:6px;">Generate</button>
            <button type="button" onclick="update()">Apply</button>
            <button type="button" onclick="del()">Delete</button>
            <button type="button" title="download datasheet with secret keys" onclick="download()">ðŸ“¥</button>
            <button type="button" title="upload datasheet with secret keys" onclick="upload()">ðŸ“¤</button>
        </section>
        <section>
            <div id="code"></div><button type="button" id="cbd" onclick="copyClbd()" hidden>ðŸ“‹</button>
        </section>
        <section>
            <div id="message"></div>
        </section>
    </main>
    <footer onclick="version(this)">&copy; <script>document.write(new Date().getFullYear())</script> D Rogatkin</footer>
</body>
</html>